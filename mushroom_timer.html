<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è˜‘è‡é‡ç”Ÿæ™‚é–“è¨ˆç®—å™¨ï¼ˆé€šçŸ¥ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      padding: 24px;
      max-width: 980px;
      margin: auto;
    }
    h2 { margin-top: 28px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display: block; font-size: 14px; margin-bottom: 6px; }
    input {
      padding: 10px; font-size: 16px; border-radius: 10px;
      border: 1px solid #ccc; width: 110px;
    }
    input.people { width: 80px; }
    input.remark { width: 260px; }
    button {
      padding: 10px 14px; font-size: 16px; border-radius: 10px;
      border: none; cursor: pointer;
    }
    .primary { background: #111; color: #fff; }
    .secondary { background: #eee; }
    .danger { background: #ffe9e9; }
    .tiny { padding: 6px 10px; font-size: 14px; border-radius: 10px; }
    .muted { color: #666; font-size: 14px; }
    .big { font-size: 20px; font-weight: 700; }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-variant-numeric: tabular-nums;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; vertical-align: top; }
    th { background: #fafafa; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    .pill {
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      border: 1px solid #ddd; font-size: 12px;
    }
    .ok { background: #f4fff4; }
    .warn { background: #fff7e6; }
    .bad { background: #ffecec; }
  </style>
</head>
<body>

<h1>è˜‘è‡é‡ç”Ÿæ™‚é–“è¨ˆç®—å™¨ï¼ˆé€šçŸ¥ç‰ˆï¼‰</h1>

<div class="card">
  <div class="muted">
    ç›®å‰ç³»çµ±æ™‚é–“ï¼š<span id="nowText" class="mono"></span>
  </div>

  <div class="actions">
    <button class="secondary" id="notifyBtn">å•Ÿç”¨é€šçŸ¥</button>
    <span id="notifyStatus" class="pill warn">é€šçŸ¥ï¼šæœªå•Ÿç”¨</span>
    <span class="muted">ï¼ˆæ‰‹æ©Ÿé€šçŸ¥éœ€ HTTPS æˆ– localhostï¼›ç€è¦½å™¨ä¸è¦å®Œå…¨é—œæ‰ï¼‰</span>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:14px 0;" />

  <div class="row">
    <div>
      <label>å‰©é¤˜ï¼ˆæ™‚ï¼‰</label>
      <input id="h" type="number" min="0" value="0">
    </div>
    <div>
      <label>å‰©é¤˜ï¼ˆåˆ†ï¼‰</label>
      <input id="m" type="number" min="0" value="0">
    </div>
    <div>
      <label>å‰©é¤˜ï¼ˆç§’ï¼‰</label>
      <input id="s" type="number" min="0" value="0">
    </div>
    <div>
      <label>äººæ•¸</label>
      <input id="people" class="people" type="number" min="1" value="5">
    </div>
    <div>
      <label>å‚™è¨»</label>
      <input id="remark" class="remark" type="text" placeholder="ä¾‹å¦‚ï¼šæ±é‚Šç¬¬ä¸‰æœµ">
    </div>
    <div>
      <button class="primary" id="calcBtn">è¨ˆç®—</button>
      <button class="secondary" id="resetBtn">é‡ç½®</button>
    </div>
  </div>

  <div id="resultBox" style="display:none;margin-top:12px;">
    <div class="muted">è˜‘è‡é‡ç”Ÿæ™‚é–“ï¼ˆå·²åŒ…å«å›ºå®š +4 åˆ†é˜ï¼‰</div>
    <div class="big mono" id="respawnText"></div>
  </div>

  <div class="actions">
    <button class="danger" id="clearHistoryBtn">æ¸…ç©ºæ­·ç¨‹</button>
    <span class="muted">ï¼ˆåŒå‚™è¨»æœƒè‡ªå‹•åˆä½µï¼›ä¾é‡ç”Ÿæ™‚é–“è¶Šè¿‘è¶Šä¸Šé¢ï¼›æœ€å¤š 10 ç­†ï¼›ä¿å­˜åœ¨ localStorageï¼‰</span>
  </div>
</div>

<h2>â± è¨ˆç®—æ­·ç¨‹</h2>

<table>
  <thead>
    <tr>
      <th>è¨ˆç®—æ™‚é–“</th>
      <th>é‡ç”Ÿæ™‚é–“</th>
      <th>äººæ•¸</th>
      <th>å‚™è¨»</th>
      <th>ç‹€æ…‹</th>
      <th style="width:88px;">æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<script>
  const FIXED_BONUS_MINUTES = 4;
  const MAX_HISTORY = 10;
  const STORAGE_KEY = "mushroom_respawn_history_notify_v1";

  const nowText = document.getElementById("nowText");
  const hEl = document.getElementById("h");
  const mEl = document.getElementById("m");
  const sEl = document.getElementById("s");
  const peopleEl = document.getElementById("people");
  const remarkEl = document.getElementById("remark");
  const respawnText = document.getElementById("respawnText");
  const resultBox = document.getElementById("resultBox");
  const historyBody = document.getElementById("historyBody");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  const notifyBtn = document.getElementById("notifyBtn");
  const notifyStatus = document.getElementById("notifyStatus");

  let history = [];
  let tickTimer = null;

  const pad2 = n => String(n).padStart(2, "0");
  const format = d =>
    `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} `
    + `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

  function updateNow() {
    nowText.textContent = format(new Date());
  }

  function normalize() {
    let h = Math.max(0, Math.floor(Number(hEl.value) || 0));
    let m = Math.max(0, Math.floor(Number(mEl.value) || 0));
    let s = Math.max(0, Math.floor(Number(sEl.value) || 0));
    let people = Math.max(1, Math.floor(Number(peopleEl.value) || 5));

    m += Math.floor(s / 60);
    s %= 60;
    h += Math.floor(m / 60);
    m %= 60;

    hEl.value = h;
    mEl.value = m;
    sEl.value = s;
    peopleEl.value = people;

    return { h, m, s, people };
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function safeRemarkKey(raw) {
    return (raw || "").trim();
  }

  function saveHistory() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch {
      return [];
    }
  }

  function sortAndTrim() {
    // ä¾é‡ç”Ÿæ™‚é–“è¶Šè¿‘ï¼ˆè¶Šæ—©åˆ°ï¼‰æ’æœ€ä¸Šé¢
    history.sort((a, b) => {
      if (a.respawnTs !== b.respawnTs) return a.respawnTs - b.respawnTs;
      return b.calcTs - a.calcTs;
    });
    history = history.slice(0, MAX_HISTORY);
  }

  // ===== é€šçŸ¥ç›¸é—œ =====
  function canUseNotification() {
    return ("Notification" in window);
  }

  function updateNotifyUI() {
    if (!canUseNotification()) {
      notifyStatus.textContent = "é€šçŸ¥ï¼šä¸æ”¯æ´";
      notifyStatus.className = "pill bad";
      notifyBtn.disabled = true;
      return;
    }

    const p = Notification.permission; // 'default' | 'granted' | 'denied'
    if (p === "granted") {
      notifyStatus.textContent = "é€šçŸ¥ï¼šå·²å•Ÿç”¨";
      notifyStatus.className = "pill ok";
      notifyBtn.textContent = "é€šçŸ¥å·²å•Ÿç”¨";
      notifyBtn.disabled = true;
    } else if (p === "denied") {
      notifyStatus.textContent = "é€šçŸ¥ï¼šå·²å°é–ï¼ˆè«‹åˆ°ç€è¦½å™¨è¨­å®šé–‹å•Ÿï¼‰";
      notifyStatus.className = "pill bad";
      notifyBtn.textContent = "å·²å°é–";
      notifyBtn.disabled = true;
    } else {
      notifyStatus.textContent = "é€šçŸ¥ï¼šæœªå•Ÿç”¨";
      notifyStatus.className = "pill warn";
      notifyBtn.textContent = "å•Ÿç”¨é€šçŸ¥";
      notifyBtn.disabled = false;
    }
  }

  async function requestNotifyPermission() {
    if (!canUseNotification()) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;

    const res = await Notification.requestPermission();
    updateNotifyUI();
    return res === "granted";
  }

  function notifyRespawn(item) {
    if (!canUseNotification()) return;
    if (Notification.permission !== "granted") return;

    const title = "ğŸ„ è˜‘è‡å·²é‡ç”Ÿ";
    const body = `${item.remark || "ï¼ˆç„¡å‚™è¨»ï¼‰"}ï½œäººæ•¸ ${item.people}`;

    // tagï¼šåŒä¸€ç­†åªå‡ºä¸€æ¬¡
    new Notification(title, {
      body,
      tag: `mushroom_${item.id}`,
      // vibrateï¼šAndroid å¯èƒ½æœ‰æ•ˆï¼›iOS æœƒå¿½ç•¥ï¼ˆä¸ç®—è²éŸ³ï¼‰
      vibrate: [200, 100, 200]
    });
  }

  // ===== ç‹€æ…‹åˆ¤æ–· =====
  function statusText(item) {
    if (item.notified) return "å·²é€šçŸ¥";
    if (Date.now() >= item.respawnTs) return "å·²é‡ç”Ÿï¼ˆå¾…é€šçŸ¥ï¼‰";
    return "å€’æ•¸ä¸­";
  }

  function renderHistory() {
    historyBody.innerHTML = "";

    if (history.length === 0) {
      historyBody.innerHTML = `<tr><td colspan="6" class="muted">å°šç„¡ç´€éŒ„</td></tr>`;
      return;
    }

    history.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${item.calc}</td>
        <td class="mono">${item.respawn}</td>
        <td>${item.people}</td>
        <td>${item.remark ? escapeHtml(item.remark) : "-"}</td>
        <td>${statusText(item)}</td>
        <td><button class="danger tiny" data-id="${item.id}">åˆªé™¤</button></td>
      `;
      historyBody.appendChild(tr);
    });

    historyBody.querySelectorAll("button[data-id]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        history = history.filter(x => x.id !== id);
        saveHistory();
        renderHistory();
      };
    });
  }

  function dedupeOnLoad() {
    // åŒå‚™è¨»åˆä½µï¼šåŒ key ç•™æœ€æ–° calcTs
    const map = new Map(); // key -> item
    history.forEach(item => {
      const key = safeRemarkKey(item.remark);
      if (key === "") {
        map.set(item.id, item); // ç©ºå‚™è¨»ä¸åˆä½µ
        return;
      }
      const prev = map.get(key);
      if (!prev || item.calcTs > prev.calcTs) map.set(key, item);
    });
    history = Array.from(map.values());
  }

  // æ¯ 1 ç§’æƒæï¼šåˆ°é»å°±é€šçŸ¥ä¸€æ¬¡
  function startNotifierTicker() {
    if (tickTimer) clearInterval(tickTimer);

    tickTimer = setInterval(() => {
      const now = Date.now();
      let changed = false;

      // åªåœ¨é€šçŸ¥æ¬Šé™å·²å…è¨±æ™‚æ‰å˜—è©¦é€šçŸ¥ï¼ˆé¿å…ä¸€ç›´æ”¹ç‹€æ…‹ï¼‰
      const canNotify = canUseNotification() && Notification.permission === "granted";

      for (const item of history) {
        if (!item.notified && now >= item.respawnTs) {
          if (canNotify) {
            notifyRespawn(item);
            item.notified = true;
            changed = true;
          }
          // è‹¥å°šæœªå…è¨±é€šçŸ¥ï¼Œç‹€æ…‹é¡¯ç¤ºã€Œå¾…é€šçŸ¥ã€ï¼Œä¸æ¨™è¨˜ notified
        }
      }

      if (changed) {
        saveHistory();
        renderHistory();
      } else {
        // æ²’æœ‰è®Šå‹•ä¹Ÿåˆ·æ–°ç‹€æ…‹æ–‡å­—ï¼ˆå€’æ•¸ä¸­/å¾…é€šçŸ¥ï¼‰è®“ UI æ¯”è¼ƒæº–
        renderHistory();
      }
    }, 1000);
  }

  // ===== äº‹ä»¶ =====
  document.getElementById("calcBtn").onclick = () => {
    const { h, m, s, people } = normalize();
    const now = new Date();
    const nowTs = now.getTime();

    const respawnTs = nowTs
      + (h * 3600 + m * 60 + s) * 1000
      + FIXED_BONUS_MINUTES * 60 * 1000;

    const target = new Date(respawnTs);

    const remark = remarkEl.value.trim();
    const key = safeRemarkKey(remark);

    respawnText.textContent = format(target);
    resultBox.style.display = "block";

    // åŒå‚™è¨»åˆä½µï¼šè‹¥ key éç©ºï¼Œå…ˆåˆªæ‰èˆŠçš„åŒ key è¨˜éŒ„
    if (key !== "") {
      history = history.filter(item => safeRemarkKey(item.remark) !== key);
    }

    // æ–°ç´€éŒ„ï¼ˆå…ˆä¸ notifiedï¼‰
    history.push({
      id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
      calc: format(now),
      respawn: format(target),
      calcTs: nowTs,
      respawnTs,
      people,
      remark,
      notified: false
    });

    sortAndTrim();
    saveHistory();
    renderHistory();
  };

  document.getElementById("resetBtn").onclick = () => {
    hEl.value = 0;
    mEl.value = 0;
    sEl.value = 0;
    peopleEl.value = 5;
    remarkEl.value = "";
    resultBox.style.display = "none";
  };

  clearHistoryBtn.onclick = () => {
    history = [];
    saveHistory();
    renderHistory();
  };

  notifyBtn.onclick = async () => {
    await requestNotifyPermission();
  };

  // ===== åˆå§‹åŒ– =====
  function init() {
    updateNow();
    setInterval(updateNow, 1000);

    updateNotifyUI();

    // è¼‰å…¥æ­·ç¨‹ï¼ˆå…¼å®¹èˆŠè³‡æ–™ï¼‰
    history = loadHistory().map(item => {
      const calcTs = Number(item.calcTs) || Date.parse(item.calc) || Date.now();
      const respawnTs = Number(item.respawnTs) || Date.parse(item.respawn) || Date.now();

      return {
        id: item.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        calc: item.calc || format(new Date(calcTs)),
        respawn: item.respawn || format(new Date(respawnTs)),
        calcTs,
        respawnTs,
        people: Number(item.people) || 5,
        remark: item.remark || "",
        notified: Boolean(item.notified) // å·²é€šçŸ¥ç‹€æ…‹ä¹ŸæŒä¹…åŒ–
      };
    });

    dedupeOnLoad();
    sortAndTrim();
    saveHistory();
    renderHistory();

    startNotifierTicker();
  }

  init();
</script>

</body>
</html>
