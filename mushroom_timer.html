<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>蘑菇重生時間計算器</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      padding: 24px;
      max-width: 980px;
      margin: auto;
    }
    h2 { margin-top: 28px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display: block; font-size: 14px; margin-bottom: 6px; }
    input {
      padding: 10px; font-size: 16px; border-radius: 10px;
      border: 1px solid #ccc; width: 110px;
    }
    input.people { width: 80px; }
    input.remark { width: 260px; }
    button {
      padding: 10px 14px; font-size: 16px; border-radius: 10px;
      border: none; cursor: pointer;
    }
    .primary { background: #111; color: #fff; }
    .secondary { background: #eee; }
    .danger { background: #ffe9e9; }
    .tiny { padding: 6px 10px; font-size: 14px; border-radius: 10px; }
    .muted { color: #666; font-size: 14px; }
    .big { font-size: 20px; font-weight: 700; }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-variant-numeric: tabular-nums;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; vertical-align: top; }
    th { background: #fafafa; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
  </style>
</head>
<body>

<h1>蘑菇重生時間計算器</h1>

<div class="card">
  <div class="muted">
    目前系統時間：<span id="nowText" class="mono"></span>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:14px 0;" />

  <div class="row">
    <div>
      <label>剩餘（時）</label>
      <input id="h" type="number" min="0" value="0">
    </div>
    <div>
      <label>剩餘（分）</label>
      <input id="m" type="number" min="0" value="0">
    </div>
    <div>
      <label>剩餘（秒）</label>
      <input id="s" type="number" min="0" value="0">
    </div>
    <div>
      <label>人數</label>
      <input id="people" class="people" type="number" min="1" value="5">
    </div>
    <div>
      <label>備註</label>
      <input id="remark" class="remark" type="text" placeholder="例如：東邊第三朵">
    </div>
    <div>
      <button class="primary" id="calcBtn">計算</button>
      <button class="secondary" id="resetBtn">重置</button>
    </div>
  </div>

  <div id="resultBox" style="display:none;margin-top:12px;">
    <div class="muted">蘑菇重生時間</div>
    <div class="big mono" id="respawnText"></div>
  </div>

  <div class="actions">
    <button class="danger" id="clearHistoryBtn">清空歷程</button>
    <span class="muted">（同備註會自動合併；依重生時間越近越上面；最多 10 筆；保存在 localStorage）</span>
  </div>
</div>

<h2>⏱ 計算歷程</h2>

<table>
  <thead>
    <tr>
      <th>計算時間</th>
      <th>重生時間</th>
      <th>人數</th>
      <th>備註</th>
      <th style="width:88px;">操作</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<script>
  const FIXED_BONUS_MINUTES = 4;
  const MAX_HISTORY = 10;
  const STORAGE_KEY = "mushroom_respawn_history_v3";

  const nowText = document.getElementById("nowText");
  const hEl = document.getElementById("h");
  const mEl = document.getElementById("m");
  const sEl = document.getElementById("s");
  const peopleEl = document.getElementById("people");
  const remarkEl = document.getElementById("remark");
  const respawnText = document.getElementById("respawnText");
  const resultBox = document.getElementById("resultBox");
  const historyBody = document.getElementById("historyBody");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  let history = [];

  const pad2 = n => String(n).padStart(2, "0");
  const format = d =>
    `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} `
    + `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

  function updateNow() {
    nowText.textContent = format(new Date());
  }

  function normalize() {
    let h = Math.max(0, Math.floor(Number(hEl.value) || 0));
    let m = Math.max(0, Math.floor(Number(mEl.value) || 0));
    let s = Math.max(0, Math.floor(Number(sEl.value) || 0));
    let people = Math.max(1, Math.floor(Number(peopleEl.value) || 5));

    m += Math.floor(s / 60);
    s %= 60;
    h += Math.floor(m / 60);
    m %= 60;

    hEl.value = h;
    mEl.value = m;
    sEl.value = s;
    peopleEl.value = people;

    return { h, m, s, people };
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function safeRemarkKey(raw) {
    // 用來做「同備註合併」的 key：去前後空白
    return (raw || "").trim();
  }

  function saveHistory() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch {
      return [];
    }
  }

  function sortAndTrim() {
    // 依重生時間（越近=越早發生）排最上面
    // respawnTs 小的在前；同時間用 calcTs 大的在前（較新的先）
    history.sort((a, b) => {
      if (a.respawnTs !== b.respawnTs) return a.respawnTs - b.respawnTs;
      return b.calcTs - a.calcTs;
    });
    history = history.slice(0, MAX_HISTORY);
  }

  function renderHistory() {
    historyBody.innerHTML = "";

    if (history.length === 0) {
      historyBody.innerHTML = `<tr><td colspan="5" class="muted">尚無紀錄</td></tr>`;
      return;
    }

    history.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${item.calc}</td>
        <td class="mono">${item.respawn}</td>
        <td>${item.people}</td>
        <td>${item.remark ? escapeHtml(item.remark) : "-"}</td>
        <td><button class="danger tiny" data-id="${item.id}">刪除</button></td>
      `;
      historyBody.appendChild(tr);
    });

    historyBody.querySelectorAll("button[data-id]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        history = history.filter(x => x.id !== id);
        saveHistory();
        renderHistory();
      };
    });
  }

  document.getElementById("calcBtn").onclick = () => {
    const { h, m, s, people } = normalize();
    const now = new Date();
    const nowTs = now.getTime();

    const respawnTs = nowTs
      + (h * 3600 + m * 60 + s) * 1000
      + FIXED_BONUS_MINUTES * 60 * 1000;

    const target = new Date(respawnTs);

    const remark = remarkEl.value.trim();
    const key = safeRemarkKey(remark);

    respawnText.textContent = format(target);
    resultBox.style.display = "block";

    // 同備註合併：若 key 非空，先刪掉舊的同 key 記錄
    if (key !== "") {
      history = history.filter(item => safeRemarkKey(item.remark) !== key);
    }

    // 新紀錄
    history.push({
      id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
      calc: format(now),
      respawn: format(target),
      calcTs: nowTs,
      respawnTs,
      people,
      remark
    });

    sortAndTrim();
    saveHistory();
    renderHistory();
  };

  document.getElementById("resetBtn").onclick = () => {
    hEl.value = 0;
    mEl.value = 0;
    sEl.value = 0;
    peopleEl.value = 5;
    remarkEl.value = "";
    resultBox.style.display = "none";
  };

  clearHistoryBtn.onclick = () => {
    history = [];
    saveHistory();
    renderHistory();
  };

  // 初始化
  history = loadHistory().map(item => {
    // 舊資料兼容：沒有 ts 就用字串解析
    const calcTs = Number(item.calcTs) || Date.parse(item.calc) || Date.now();
    const respawnTs = Number(item.respawnTs) || Date.parse(item.respawn) || Date.now();

    return {
      id: item.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`,
      calc: item.calc || format(new Date(calcTs)),
      respawn: item.respawn || format(new Date(respawnTs)),
      calcTs,
      respawnTs,
      people: Number(item.people) || 5,
      remark: item.remark || ""
    };
  });

  // 初始化也做一次「同備註合併」+ 排序（同備註留最新 calcTs）
  (function dedupeOnLoad() {
    const map = new Map(); // key -> item
    history.forEach(item => {
      const key = safeRemarkKey(item.remark);
      if (key === "") {
        // 空備註不合併，讓它各自存在：用 unique key
        map.set(item.id, item);
        return;
      }
      const prev = map.get(key);
      if (!prev || item.calcTs > prev.calcTs) {
        map.set(key, item);
      }
    });

    // map 可能含空備註用 id 當 key 的項目
    history = Array.from(map.values());
    sortAndTrim();
    saveHistory();
    renderHistory();
  })();

  updateNow();
  setInterval(updateNow, 1000);
</script>

</body>
</html>
